<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post</title>
    
    <!-- Required CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>

    <style>
        /* Custom Styles */
        body {
            @apply bg-gray-50 p-0 m-0 min-h-screen;
        }
        .select2-container--default .select2-selection--multiple {
            @apply border-gray-300 rounded-lg shadow-sm;
        }
        .ck-editor__editable_inline {
            @apply min-h-[60vh] border-gray-300 rounded-lg shadow-sm;
        }
        .ck-powered-by {
            display: none !important;
        }
        .attachment-item {
            @apply flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors;
        }
        .drag-active {
            @apply border-blue-500 bg-blue-50;
        }
        .form-row {
            @apply grid grid-cols-1 md:grid-cols-4 gap-4 items-center mb-4;
        }
        .form-row > div {
            @apply col-span-1;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-6 w-full">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Create New Post</h1>
        
        <form id="postForm" class="space-y-6 w-full">
            <!-- Form Fields in Single Line -->
            <div class="form-row">
                <!-- Title Field -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                    <input type="text" id="title" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Classrooms Select -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Classrooms</label>
                    <select id="classrooms" multiple class="w-full classroom-select"></select>
                </div>

                <!-- Submission Fields -->
                <div id="submissionFields" class="hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deadline</label>
                        <input type="datetime-local" id="deadline"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Allow Submissions -->
                <div id="allowSubmissionsField" class="hidden flex items-center pt-6">
                    <input type="checkbox" id="allowSubmissions" 
                        class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label class="ml-2 block text-sm text-gray-700">Allow Submissions</label>
                </div>
            </div>

            <!-- Editor (Full Width) -->
            <div class="w-full">
                <label class="block text-sm font-medium text-gray-700 mb-2">Post Content</label>
                <div id="editor"></div>
            </div>

            <!-- Attachments (Full Width) -->
            <div class="w-full">
                <label class="block text-sm font-medium text-gray-700 mb-2">Attachments</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-dashed border-gray-300 rounded-lg relative"
                    id="dropZone">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-4 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="flex text-sm text-gray-600 justify-center">
                            <label for="attachments" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                <span>Upload files</span>
                                <input type="file" id="attachments" multiple class="sr-only">
                            </label>
                            <p class="pl-1">or drag and drop</p>
                        </div>
                        <p class="text-xs text-gray-500">Any file types, no size limits</p>
                    </div>
                </div>
                <div id="attachmentList" class="mt-4 grid gap-2"></div>
            </div>

            <!-- Submit Button (Full Width) -->
            <button type="submit" 
                class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                Create Post
            </button>
        </form>
    </div>

    <script>
        // Function to get path parameter
        function getPathParam() {
            const path = window.location.pathname;
            const segments = path.split('/').filter(segment => segment);
            return segments.length > 0 ? segments[0] : null;
        }

        // Initialize Select2 with API data
        $(document).ready(function() {
            // Check path parameter and show/hide fields
            const pathParam = getPathParam();
            if (pathParam === 'Homework') {
                document.getElementById('submissionFields').classList.remove('hidden');
                document.getElementById('allowSubmissionsField').classList.remove('hidden');
            }

            $('.classroom-select').select2({
                placeholder: 'Select classrooms',
                allowClear: true,
                width: '100%'
            });

            fetch('https://enrol.arabicschool.org.au/api/classrooms')
                .then(response => response.json())
                .then(data => {
                    data.forEach(classroom => {
                        $('.classroom-select').append(
                            new Option(classroom.Name, classroom.Id, false, false)
                        );
                    });
                }).catch(error => console.error('Error loading classrooms:', error));
        });

        // Initialize CKEditor
        let editor;
        ClassicEditor
            .create(document.querySelector('#editor'), {
                toolbar: {
                    items: [
                        'undo', 'redo',
                        '|', 'bold', 'italic', 'underline',
                        '|', 'link', 'mediaEmbed',
                        '|', 'numberedList',
                        '|', 'fontSize',
                        '|', 'alignment:right'
                    ]
                },
                fontSize: {
                    options: [10, 12, 14, 'default', 18, 20, 24]
                },
                alignment: {
                    options: ['right']
                },
                link: {
                    addTargetToExternalLinks: true,
                    defaultProtocol: 'https://',
                    autoLink: true
                },
                mediaEmbed: {
                    previewsInData: true
                },
                removePlugins: ['UploadAdapter']
            })
            .then(instance => {
                editor = instance;
            })
            .catch(error => console.error('Editor initialization error:', error));

        // File handling system
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('attachments');
        let filesArray = [];

        // Drag-drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-active');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            handleFiles(e.dataTransfer.files);
        });

        // File input handler
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(newFiles) {
            const updatedFiles = [...filesArray];
            Array.from(newFiles).forEach(newFile => {
                if (!updatedFiles.some(existingFile => 
                    existingFile.name === newFile.name &&
                    existingFile.size === newFile.size &&
                    existingFile.lastModified === newFile.lastModified
                )) {
                    updatedFiles.push(newFile);
                }
            });
            filesArray = updatedFiles;
            updateFileDisplay();
            updateFileInput();
        }

        function updateFileDisplay() {
            const list = document.getElementById('attachmentList');
            list.innerHTML = filesArray.map((file, index) => `
                <div class="attachment-item">
                    <div class="flex items-center space-x-3">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span class="text-sm font-medium text-gray-700">${file.name}</span>
                        <span class="text-xs text-gray-500">${file.type || 'unknown type'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">${(file.size/1024/1024).toFixed(2)} MB</span>
                        <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                            ×
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateFileInput() {
            const dataTransfer = new DataTransfer();
            filesArray.forEach(file => dataTransfer.items.add(file));
            fileInput.files = dataTransfer.files;
        }

        window.removeFile = (index) => {
            filesArray = filesArray.filter((_, i) => i !== index);
            updateFileDisplay();
            updateFileInput();
        };

        // Form submission
        document.getElementById('postForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData();
            
            formData.append('title', document.getElementById('title').value);
            formData.append('content', editor.getData());
            
            filesArray.forEach(file => {
                formData.append('attachments[]', file);
            });

            // Add your submission logic here
            console.log('Form data ready for submission:', formData);
        });
    </script>
</body>
</html>

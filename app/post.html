<!DOCTYPE html>
<html lang="en">
<head>
    <!-- CDN imports and existing styles remain unchanged -->
    <style>
        /* Add deleted attachment styling */
        .attachment-item.removed {
            position: relative;
            opacity: 0.7;
        }
        .attachment-item.removed::after {
            content: "DELETED";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #dc2626;
            font-weight: bold;
            font-size: 1.2em;
            border: 2px dashed #dc2626;
        }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <!-- Existing HTML structure remains unchanged -->

    <script>
        let editor, filesArray = [], removedAttachments = [];
        
        function getPathParam() {
            const segments = window.location.pathname.split('/').filter(Boolean);
            return segments.length > 1 ? segments[1] : null;
        }

        async function fetchPostData(postId) {
            try {
                const [postRes, classroomsRes] = await Promise.all([
                    fetch(`/api/posts/${postId}`),
                    fetch('/api/classrooms')
                ]);
                
                if (!postRes.ok || !classroomsRes.ok) throw new Error('Data loading failed');
                
                return {
                    post: await postRes.json(),
                    classrooms: await classroomsRes.json()
                };
            } catch (error) {
                alert('Error loading data');
                window.location.href = '/';
            }
        }

        function populateForm(data) {
            const { post, classrooms, privacySettings, attachments } = data;
            
            document.getElementById('title').value = post.title;
            editor.setData(post.body);
            
            if (post.type === 'Homework') {
                const deadline = new Date(post.deadline);
                deadline.setMinutes(deadline.getMinutes() - deadline.getTimezoneOffset());
                document.getElementById('deadline').value = deadline.toISOString().slice(0,16);
                document.getElementById('allowSubmissions').checked = post.submissionallowed;
            }

            classrooms.forEach(c => $('#classrooms').append(new Option(c.Name, c.Id)));
            $('#classrooms').val(privacySettings.map(p => p.classroom.toString())).trigger('change');

            attachments.forEach(a => {
                document.getElementById('attachmentList').innerHTML += `
                    <div class="attachment-item existing-attachment" data-attachment-id="${a.id}">
                        <div class="flex items-center gap-2">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="text-sm font-medium text-gray-700">${a.originname}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <a href="${a.path}" target="_blank" class="text-blue-500 hover:text-blue-700">View</a>
                            <button type="button" onclick="removeExistingAttachment(${a.id})" class="text-red-500 hover:text-red-700">×</button>
                        </div>
                    </div>
                `;
            });
        }

        function removeExistingAttachment(id) {
            removedAttachments.push(id);
            const el = document.querySelector(`[data-attachment-id="${id}"]`);
            if (el) el.classList.add('removed');
        }

        $(document).ready(async function() {
            const postId = getPathParam();
            const isEditMode = !!postId;
            
            ClassicEditor.create(document.querySelector('#editor'), {
                toolbar: ['undo','redo','|','bold','italic','underline','|','link','mediaEmbed','|','numberedList','|','fontSize','|','alignment:right'],
                fontSize: {options:[10,12,14,'default',18,20,24]},
                alignment: {options:['right']},
                link: {addTargetToExternalLinks:true, defaultProtocol:'https://', autoLink:true},
                mediaEmbed: {previewsInData:true},
                removePlugins:['UploadAdapter']
            }).then(instance => editor = instance);

            $('.classroom-select').select2({placeholder:'Select classrooms',allowClear:true,width:'100%'});

            if (isEditMode) {
                try {
                    const { post, classrooms } = await fetchPostData(postId);
                    document.querySelector('h1').textContent = 'Edit Post';
                    document.querySelector('button[type="submit"]').textContent = 'Update Post';
                    populateForm({
                        ...post.post,
                        classrooms,
                        privacySettings: post.privacySettings,
                        attachments: post.attachments
                    });
                } catch(error) {
                    console.error(error);
                }
            } else {
                fetch('/api/classrooms')
                    .then(r => r.json())
                    .then(classrooms => classrooms.forEach(c => 
                        $('#classrooms').append(new Option(c.Name, c.Id))
                    ));
            }

            const dropZone = document.getElementById('dropZone');
            ['dragover','dragleave','drop'].forEach(evt => {
                dropZone.addEventListener(evt, e => {
                    e.preventDefault();
                    dropZone.classList.toggle('drag-active', evt === 'dragover');
                    if (evt === 'drop') handleFiles(e.dataTransfer.files);
                });
            });

            document.getElementById('attachments').addEventListener('change', e => handleFiles(e.target.files));

            function handleFiles(newFiles) {
                filesArray = [...filesArray, ...newFiles];
                renderFiles();
                const dt = new DataTransfer();
                filesArray.forEach(f => dt.items.add(f));
                document.getElementById('attachments').files = dt.files;
            }

            function renderFiles() {
                document.getElementById('attachmentList').innerHTML = filesArray.map((f,i) => `
                    <div class="attachment-item">
                        <div class="flex items-center gap-2">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="text-sm font-medium text-gray-700">${f.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500">${(f.size/1024/1024).toFixed(2)} MB</span>
                            <button type="button" onclick="filesArray.splice(${i},1); renderFiles();" class="text-red-500 hover:text-red-700">×</button>
                        </div>
                    </div>
                `).join('');
            }
        });

        document.getElementById('postForm').addEventListener('submit', async e => {
            e.preventDefault();
            const postId = getPathParam();
            const isEditMode = !!postId;
            const formData = new FormData();
            
            if (isEditMode) formData.append('id', postId);
            formData.append('title', document.getElementById('title').value);
            formData.append('content', editor.getData());
            formData.append('submissionallowed', document.getElementById('allowSubmissions').checked);
            formData.append('type', isEditMode ? 'Homework' : getPathParam());
            removedAttachments.forEach(id => formData.append('removedAttachments[]', id));
            
            if (document.getElementById('allowSubmissions').checked) {
                formData.append('deadline', document.getElementById('deadline').value);
            }

            Array.from(document.getElementById('attachments').files).forEach(f => formData.append('attachments[]', f));

            try {
                const response = await fetch(
                    isEditMode ? `/api/posts/${postId}` : '/api/posts',
                    {method: isEditMode ? 'PUT' : 'POST', body: formData}
                );
                
                if (!response.ok) throw new Error('Submission failed');
                window.location.href = '/posts';
            } catch (error) {
                alert(error.message);
            }
        });
    </script>
</body>
</html>

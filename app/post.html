<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title id="pageTitle">Create New Post</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
  <style>
    .ck.ck-editor { border-radius: .5rem; overflow: hidden }
    .ck-editor__editable_inline { min-height:50vh; border:1px solid #d1d5db; border-radius:.5rem; box-shadow:0 1px 2px rgba(0,0,0,0.05) }
    a.ck-powered-by, .ck.ck-powered-by { display:none!important }
    .form-row { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1.5rem }
    .form-group { flex:1 1 200px }
    .attachment-item { position:relative; display:flex; align-items:center; gap:.75rem; padding:.75rem; border:1px solid #e5e7eb; border-radius:.5rem; background:#f9fafb }
    .attachment-item:hover { background:#f3f4f6 }
    .attachment-item button { position:absolute; top:.25rem; right:.25rem; background:transparent; border:none; font-size:1rem; color:#ef4444; cursor:pointer }
    .attachment-item button:hover { color:#b91c1c }
    .drag-active { border-color:#3b82f6; background:#eff6ff }
  </style>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-[1800px] mx-auto">
    <h1 id="heading" class="text-3xl font-bold text-gray-900 mb-6">Create New Post</h1>
    <form id="postForm" class="space-y-6">
      <div class="form-row">
        <div class="form-group">
          <label class="block text-sm font-medium text-gray-700">Program</label>
          <select id="program" class="w-full px-3 py-2 border rounded-lg"></select>
        </div>
        <div class="form-group">
          <label class="block text-sm font-medium text-gray-700">Classroom</label>
          <select id="classroom" class="w-full px-3 py-2 border rounded-lg"></select>
        </div>
        <div class="form-group">
          <label class="block text-sm font-medium text-gray-700">Type</label>
          <select id="type" class="w-full px-3 py-2 border rounded-lg">
            <option value="Announcement">Announcement</option>
            <option value="Homework">Homework</option>
            <option value="Note">Note</option>
          </select>
        </div>
        <div class="form-group">
          <label class="block text-sm font-medium text-gray-700">Privacy Classrooms</label>
          <select id="privacyClassrooms" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg"></select>
        </div>
        <div class="form-group">
          <label class="block text-sm font-medium text-gray-700">Title</label>
          <input type="text" id="title" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="inline-flex items-center"><input type="checkbox" id="submissionAllowed" class="form-checkbox"/><span class="ml-2">Allow Submissions</span></label>
        </div>
        <div class="form-group">
          <label class="inline-flex items-center"><input type="checkbox" id="draft" class="form-checkbox"/><span class="ml-2">Draft</span></label>
        </div>
        <div class="form-group">
          <label class="inline-flex items-center"><input type="checkbox" id="sendOnUpdate" class="form-checkbox"/><span class="ml-2">Send on Update</span></label>
        </div>
        <div class="form-group">
          <label class="block text-sm font-medium text-gray-700">Deadline</label>
          <input type="datetime-local" id="deadline" class="w-full px-3 py-2 border rounded-lg"/>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Post Content</label>
        <div id="editor"></div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Attachments</label>
        <div id="dropZone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-dashed border-gray-300 rounded-lg">
          <div class="space-y-1 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-4 4h.02"/></svg>
            <div class="flex text-sm text-gray-600 justify-center">
              <label for="newAttachments" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                <span>Upload files</span>
                <input type="file" id="newAttachments" multiple class="sr-only"/>
              </label>
              <p class="pl-1">or drag and drop</p>
            </div>
            <p class="text-xs text-gray-500">Any file types, no size limits</p>
          </div>
        </div>
        <div id="attachmentList" class="mt-4 grid gap-2"></div>
      </div>
      <button type="submit" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">Save Post</button>
    </form>
  </div>
  <script>
    function getPostId(){return window.location.pathname.split('/').filter(Boolean)[1]||null;}
    (function($){
      $(async()=>{
        const postId=getPostId();
        if(postId){$('#pageTitle').text('Edit Post');$('#heading').text('Edit Post');}
        $('#program,#classroom,#privacyClassrooms').select2({width:'100%'});
        const [progs,classes]=await Promise.all([fetch('/api/programs').then(r=>r.json()),fetch('/api/classrooms').then(r=>r.json())]);
        progs.forEach(p=>$('#program').append(new Option(p.name,p.id)));
        classes.forEach(c=>{$('#classroom').append(new Option(c.Name,c.Id));$('#privacyClassrooms').append(new Option(c.Name,c.Id));});
        const editor=await ClassicEditor.create(document.querySelector('#editor'),{toolbar:['undo','redo','|','bold','italic','underline','|','link','mediaEmbed','|','numberedList','|','fontSize','|','alignment:right'],link:{addTargetToExternalLinks:true,autoLink:true,defaultProtocol:'https://'},mediaEmbed:{previewsInData:true},removePlugins:['UploadAdapter']});
        let newFiles=[];let existing=[];const toDelete=new Set();
        function renderAttachments(){
          const $list=$('#attachmentList').empty();
          existing.forEach(att=>{if(toDelete.has(att.id))return;const $item=$(\`<div class="attachment-item">\${att.filemime.startsWith('video/')?`<img src="\${att.thumbnail}" class="h-12 w-12 rounded" alt="thumb">`:`<svg class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16v-4a1 1 0 011-1h3m5 0h.01M14 16v-4m-4 4v-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`}<a href="\${att.path}" target="_blank" class="flex-1 text-sm font-medium text-gray-700 hover:underline">\${att.originname}</a><button title="Remove">&times;</button></div>\`);$item.find('button').click(()=>{toDelete.add(att.id);renderAttachments();});$list.append($item);});
          newFiles.forEach((file,idx)=>{const thumb=file.type.startsWith('video/')?URL.createObjectURL(file):null;const $item=$(\`<div class="attachment-item">\${thumb?`<video src="\${thumb}" class="h-12 w-12 rounded" muted loop autoplay></video>`:`<svg class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16v-4a1 1 0 011-1h3m5 0h.01M14 16v-4m-4 4v-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`}<span class="flex-1 text-sm font-medium text-gray-700">\${file.name}</span><button title="Remove">&times;</button></div>\`);$item.find('button').click(()=>{newFiles.splice(idx,1);renderAttachments();});$list.append($item);});
        }
        $('#dropZone').on('dragover dragleave drop',e=>{e.preventDefault();if(e.type==='dragover')$('#dropZone').addClass('drag-active');if(e.type==='dragleave'||e.type==='drop')$('#dropZone').removeClass('drag-active');if(e.type==='drop')handleNewFiles(e.originalEvent.dataTransfer.files);});
        $('#newAttachments').on('change',e=>handleNewFiles(e.target.files));
        function handleNewFiles(files){Array.from(files).forEach(f=>{if(!newFiles.some(x=>x.name===f.name&&x.size===f.size))newFiles.push(f);});renderAttachments();}
        if(postId){const res=await fetch(\`/api/posts/\${postId}\`);if(res.ok){const data=await res.json();editor.setData(data.body);existing=(data.attachments||[]).map(a=>({id:a.id,originname:a.originname,path:a.path,filemime:a.filemime,thumbnail:a.thumbnail}));renderAttachments();}}
        $('#postForm').on('submit',async e=>{e.preventDefault();const fd=new FormData();fd.append('program',$('#program').val());fd.append('classroom',$('#classroom').val());fd.append('type',$('#type').val());fd.append('title',$('#title').val());fd.append('body',editor.getData());fd.append('submissionallowed',$('#submissionAllowed').prop('checked'));fd.append('draft',$('#draft').prop('checked'));fd.append('sendonupdate',$('#sendOnUpdate').prop('checked'));fd.append('deadline',$('#deadline').val());newFiles.forEach(f=>fd.append('attachments[]',f));toDelete.forEach(id=>fd.append('deletedAttachments[]',id));const method=postId?'PUT':'POST';const url=postId?\`/api/posts/\${postId}\`:'/api/posts';await fetch(url,{method,body:fd});});
      });
    })(jQuery);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post</title>
    
    <!-- Required CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>

    <style>
        /* Custom CSS fixes */
        .select2-container--default .select2-selection--multiple {
            @apply border-gray-300 rounded-lg shadow-sm;
        }
        
        /* CKEditor customizations */
        .ck-editor__editable_inline {
            @apply min-h-[400px] border-gray-300 rounded-lg shadow-sm;
        }
        
        /* Hide powered by banner */
        .ck-powered-by {
            display: none !important;
        }
        
        .attachment-item {
            @apply flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-4xl mx-auto p-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Create New Post</h1>
        
        <form id="postForm" class="space-y-6">
            <!-- Title Field -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                <input type="text" id="title" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Classrooms Select -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Classrooms</label>
                <select id="classrooms" multiple
                    class="w-full classroom-select"></select>
            </div>

            <!-- Submission Fields -->
            <div id="submissionFields" class="hidden space-y-4 bg-blue-50 p-4 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Submission Deadline</label>
                        <input type="datetime-local" id="deadline"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex items-center pt-6">
                        <input type="checkbox" id="allowSubmissions" 
                            class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label class="ml-2 block text-sm text-gray-700">Allow Submissions</label>
                    </div>
                </div>
            </div>

            <!-- Editor -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Post Content</label>
                <div id="editor"></div>
            </div>

            <!-- Attachments -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Attachments</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-dashed border-gray-300 rounded-lg">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-4 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="flex text-sm text-gray-600 justify-center">
                            <label for="attachments" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                <span>Upload files</span>
                                <input type="file" id="attachments" multiple class="sr-only">
                            </label>
                            <p class="pl-1">or drag and drop</p>
                        </div>
                        <p class="text-xs text-gray-500">Any file types, no size limits</p>
                    </div>
                </div>
                <div id="attachmentList" class="mt-4 grid gap-2"></div>
            </div>

            <!-- Submit Button -->
            <button type="submit" 
                class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                Create Post
            </button>
        </form>
    </div>

    <script>
        // Initialize Select2 with API data
        $(document).ready(function() {
            $('.classroom-select').select2({
                placeholder: 'Select classrooms',
                allowClear: true,
                width: '100%'
            });

            fetch('https://enrol.arabicschool.org.au/api/classrooms')
                .then(response => response.json())
                .then(data => {
                    data.forEach(classroom => {
                        $('.classroom-select').append(
                            new Option(classroom.Name, classroom.Id, false, false)
                        );
                    });
                }).catch(error => console.error('Error loading classrooms:', error));
        });

        // Conditional fields based on path
        const path = window.location.pathname;
        if (path.includes('Homework')) {
            document.getElementById('submissionFields').classList.remove('hidden');
        }

        // Initialize CKEditor with custom configuration
        let editor;

        ClassicEditor
            .create(document.querySelector('#editor'), {
                toolbar: {
                    items: [
                        'undo', 'redo',
                        '|', 'bold', 'italic', 'underline',
                        '|', 'link', 'mediaEmbed',
                        '|', 'numberedList',
                        '|', 'fontSize',
                        '|', 'alignment:right'
                    ]
                },
                fontSize: {
                    options: [10, 12, 14, 'default', 18, 20, 24]
                },
                alignment: {
                    options: ['right']
                },
                link: {
                    addTargetToExternalLinks: true,
                    defaultProtocol: 'https://',
                    autoLink: true
                },
                mediaEmbed: {
                    previewsInData: true
                },
                removePlugins: ['UploadAdapter']
            })
            .then(instance => {
                editor = instance;
            })
            .catch(error => console.error('Editor initialization error:', error));

        // File upload handling
        document.getElementById('attachments').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const list = document.getElementById('attachmentList');
            
            list.innerHTML = files.map(file => `
                <div class="attachment-item">
                    <div class="flex items-center space-x-3">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span class="text-sm font-medium text-gray-700">${file.name}</span>
                        <span class="text-xs text-gray-500">${file.type || 'unknown type'}</span>
                    </div>
                    <span class="text-sm text-gray-500">${(file.size/1024/1024).toFixed(2)} MB</span>
                </div>
            `).join('');
        });

        // Form validation
        document.getElementById('postForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData();
            
            // Add form fields
            formData.append('title', document.getElementById('title').value);
            formData.append('content', editor.getData());
            
            // Add files
            const fileInput = document.getElementById('attachments');
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('attachments[]', fileInput.files[i]);
            }

            // Submit formData using fetch() or XMLHttpRequest
            console.log('Form data ready for submission:', formData);
        });
    </script>
</body>
</html>
